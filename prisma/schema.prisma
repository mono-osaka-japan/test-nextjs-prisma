// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. User - ユーザー
// ============================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  avatarUrl     String?
  role          String    @default("USER") // USER, ADMIN, MODERATOR
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  bookmarks     Bookmark[]
  notifications Notification[]
  following     Follow[]       @relation("Following")
  followers     Follow[]       @relation("Followers")
  profile       Profile?
  auditLogs     AuditLog[]
  patterns      Pattern[]
  campaigns     Campaign[]
  assignedTasks CampaignTask[] @relation("AssignedTasks")

  @@index([email])
  @@index([createdAt])
}

// ============================================
// 2. Account - 認証アカウント (OAuth)
// ============================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refreshToken      String?
  accessToken       String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String?
  sessionState      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// ============================================
// 3. Session - セッション
// ============================================
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
}

// ============================================
// 4. VerificationToken - メール検証トークン
// ============================================
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// 5. Profile - ユーザープロフィール
// ============================================
model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  bio       String?
  location  String?
  website   String?
  birthdate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// 6. Category - カテゴリー
// ============================================
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts Post[]

  @@index([slug])
}

// ============================================
// 7. Tag - タグ
// ============================================
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  // Relations
  posts PostTag[]

  @@index([slug])
}

// ============================================
// 8. Post - 投稿
// ============================================
model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  excerpt     String?
  coverImage  String?
  status      String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  publishedAt DateTime?
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  authorId   String
  categoryId String?

  // Relations
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category  Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags      PostTag[]
  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]
  media     Media[]

  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

// ============================================
// 9. PostTag - 投稿とタグの中間テーブル
// ============================================
model PostTag {
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([tagId])
}

// ============================================
// 10. Comment - コメント
// ============================================
model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign Keys
  authorId String
  postId   String
  parentId String?

  // Relations
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post     Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  @@index([authorId])
  @@index([postId])
  @@index([parentId])
  @@index([createdAt])
}

// ============================================
// 11. Like - いいね
// ============================================
model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  userId String
  postId String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

// ============================================
// 12. Bookmark - ブックマーク
// ============================================
model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  userId String
  postId String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

// ============================================
// 13. Follow - フォロー
// ============================================
model Follow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  followerId  String
  followingId String

  // Relations
  follower  User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId])
}

// ============================================
// 14. Notification - 通知
// ============================================
model Notification {
  id        String   @id @default(cuid())
  type      String   // LIKE, COMMENT, FOLLOW, MENTION, SYSTEM
  title     String
  message   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Foreign Keys
  userId String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// 15. Media - メディア（画像・ファイル）
// ============================================
model Media {
  id        String   @id @default(cuid())
  filename  String
  mimeType  String
  size      Int
  url       String
  alt       String?
  createdAt DateTime @default(now())

  // Foreign Keys
  postId String?

  // Relations
  post Post? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([postId])
  @@index([createdAt])
}

// ============================================
// 16. AuditLog - 監査ログ
// ============================================
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entity    String   // User, Post, Comment, etc.
  entityId  String?
  oldValue  String?  // JSON string
  newValue  String?  // JSON string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Foreign Keys
  userId String?

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// 17. SystemGroup - システムグループ
// ============================================
model SystemGroup {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  patterns  Pattern[]

  @@index([name])
  @@index([isActive])
}

// ============================================
// 18. Campaign - 案件
// ============================================
model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED, CANCELLED
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  targetUrl   String?

  // 認証情報（URL解析で抽出）
  authType    String?  // NONE, BASIC, BEARER, API_KEY, OAUTH
  authConfig  String?  // JSON: { username, password, token, apiKey, etc. }

  // メタデータ
  metadata    String?  // JSON: 追加の設定や情報

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  ownerId     String

  // Relations
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tasks       CampaignTask[]
  patterns    Pattern[]

  @@index([ownerId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ============================================
// 19. CampaignTask - 案件タスク
// ============================================
model CampaignTask {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("TODO") // TODO, IN_PROGRESS, DONE, CANCELLED
  dueDate     DateTime?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  campaignId  String
  assigneeId  String?

  // Relations
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  assignee    User?    @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([assigneeId])
  @@index([status])
}

// ============================================
// 20. Pattern - パターン（自動化テンプレート）
// ============================================
model Pattern {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("DEFAULT") // DEFAULT, A/B_TEST, PERSONALIZED, etc.
  config      String?  // JSON string for pattern configuration
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  authorId      String?
  campaignId    String?
  systemGroupId String?

  // Relations
  author      User?         @relation(fields: [authorId], references: [id], onDelete: SetNull)
  campaign    Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  systemGroup SystemGroup?  @relation(fields: [systemGroupId], references: [id], onDelete: SetNull)
  steps       PatternStep[]
  testResults PatternTestResult[]

  @@index([name])
  @@index([type])
  @@index([isActive])
  @@index([authorId])
  @@index([campaignId])
  @@index([systemGroupId])
}

// ============================================
// 21. PatternStep - パターンステップ
// ============================================
model PatternStep {
  id          String   @id @default(cuid())
  name        String
  description String?
  action      String   // ACTION_TYPE: NOTIFY, VALIDATE, TRANSFORM, WEBHOOK, etc.
  config      String   // JSON config for the action
  sortOrder   Int      @default(0)
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  patternId String

  // Relations
  pattern Pattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@index([patternId])
  @@index([sortOrder])
}

// ============================================
// 22. PatternTestResult - パターンテスト結果
// ============================================
model PatternTestResult {
  id          String   @id @default(cuid())
  status      String   // PENDING, RUNNING, SUCCESS, FAILED
  input       String?  // JSON test input
  output      String?  // JSON test output
  error       String?
  duration    Int?     // milliseconds
  createdAt   DateTime @default(now())

  // Foreign Keys
  patternId String

  // Relations
  pattern Pattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@index([patternId])
  @@index([status])
  @@index([createdAt])
}
